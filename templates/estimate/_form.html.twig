<div class="mt-12 p-8 bg-white text-gray-900 rounded-xl">

    {% if button_label is defined %}
        <h1 class="text-4xl font-extrabold mb-8">Modifier la Pré‑Estimation</h1>
    {% else %}
        <h1 class="text-4xl font-extrabold mb-8">Nouvelle Pré‑Estimation</h1>
    {% endif %}

    {{ form_start(form, {'attr': {'class': 'space-y-6', 'enctype': 'multipart/form-data'}}) }}

    <fieldset class="bg-gray-50 p-6 rounded-lg space-y-6">
        <legend class="text-lg font-semibold text-gray-900">Informations générales</legend>

        <div class="space-y-2" data-controller="client-modal" data-client-modal-endpoint-value="{{ path('client_create_from_modal') }}">
            {{ form_label(form.client, 'Client', {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
            {{ form_widget(form.client, {
                'attr': {
                    'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900',
                    'data-client-modal-target': 'clientSelect'
                }
            }) }}
            {{ form_errors(form.client) }}
            <div class="flex flex-wrap gap-3 text-sm">
                <button type="button" class="text-blue-600 hover:text-blue-700" data-action="click->client-modal#openModal touchstart->client-modal#openModal">+ Ajouter un nouveau client</button>
                <a href="{{ path('app_client_new') }}" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-700">Ouvrir dans un nouvel onglet</a>
            </div>

            <div data-client-modal-target="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
                <div class="w-full max-w-md rounded-lg bg-white p-6 text-gray-900 shadow-xl">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">Créer un client</h2>
                        <button type="button" class="text-gray-500 hover:text-gray-700" data-action="click->client-modal#closeModal touchstart->client-modal#closeModal">X</button>
                    </div>
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">Nom</label>
                            <input type="text" class="w-full rounded-md border border-gray-300 px-3 py-2" data-client-modal-target="nameInput" data-action="keydown.enter->client-modal#createClient" />
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">Devise</label>
                            <select class="w-full rounded-md border border-gray-300 px-3 py-2" data-client-modal-target="currencySelect">
                                <option value="">Sélectionnez une devise</option>
                                <option value="EUR">Euro (€)</option>
                                <option value="MAD">Dirham marocain (MAD)</option>
                                <option value="USD">Dollar américain ($)</option>
                            </select>
                        </div>
                        <div data-client-modal-target="error" class="hidden text-sm text-red-700 bg-red-50 border border-red-200 rounded-md px-3 py-2"></div>
                        <div class="flex justify-end gap-2">
                            <button type="button" class="px-3 py-2 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-800" data-action="click->client-modal#closeModal touchstart->client-modal#closeModal">Annuler</button>
                            <button type="button" class="px-3 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white" data-action="click->client-modal#createClient touchstart->client-modal#createClient">Créer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if form.estimateNumber is defined %}
            <div class="space-y-2">
                {{ form_label(form.estimateNumber, 'Référence', {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
                {{ form_widget(form.estimateNumber, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
                {{ form_errors(form.estimateNumber) }}
            </div>
        {% endif %}

        <div class="space-y-2">
            {{ form_label(form.name, 'Nom', {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
            {{ form_widget(form.name, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
            {{ form_errors(form.name) }}
        </div>

        <div class="space-y-2">
            {{ form_label(form.description, 'Description', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
            <div
                data-controller="ckeditor"
                data-ckeditor-toolbar-value='["bold","italic","bulletedList","numberedList","undo","redo"]'
                data-ckeditor-license-key-value="GPL"
            >
                {{ form_widget(form.description, {
                    attr: { 'data-ckeditor-target':'textarea', rows:10, class:'mt-1 w-full rounded-md border-gray-300 bg-white' }
                }) }}
            </div>
            {{ form_errors(form.description) }}
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                {{ form_label(form.startDate, 'Date de début', {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
                {{ form_widget(form.startDate, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
                {{ form_errors(form.startDate) }}
            </div>
            <div>
                {{ form_label(form.endDate, 'Date de fin', {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
                {{ form_widget(form.endDate, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
                {% if form.endDate.vars.errors|length > 0 %}
                    <div class="mt-2 text-sm font-semibold text-red-700 bg-red-50 border border-red-200 rounded-md px-3 py-2">
                        <div class="flex items-start gap-2">
                            <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-red-100 text-red-700 text-xs font-bold">!</span>
                            <div>
                                <div class="uppercase tracking-wide text-[11px] text-red-700">Erreur</div>
                                {{ form_errors(form.endDate) }}
                            </div>
                        </div>
                    </div>
                {% else %}
                    {{ form_errors(form.endDate) }}
                {% endif %}
                <p class="text-xs text-gray-500 mt-1">La date de fin doit être postérieure ou égale à la date de début.</p>
            </div>
        </div>

        <div class="space-y-2">
            {{ form_label(form.amount, 'Montant HT', {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
            {{ form_widget(form.amount, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
            {{ form_errors(form.amount) }}
        </div>

        <div data-controller="toggle-vat">
            <div class="flex flex-col sm:flex-row sm:items-center gap-2 mb-4">
                {{ form_widget(form.noVat, {
                    'attr': {
                        'data-toggle-vat-target': 'checkbox',
                        'data-action': 'toggle-vat#toggle'
                    }
                }) }}
                {{ form_label(form.noVat, 'Pas de TVA', {'label_attr': {'class': 'text-sm text-gray-900'}}) }}
            </div>

            <div data-toggle-vat-target="vat" class="mb-4">
                {{ form_label(form.vatRate, 'TVA (%)', {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
                {{ form_widget(form.vatRate, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900', 'step': '0.01'}}) }}
                {{ form_errors(form.vatRate) }}
            </div>
        </div>

        <div>
            {{ form_label(form.status, 'Statut', {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
            {{ form_widget(form.status, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
            {{ form_errors(form.status) }}
        </div>

        {# Documents liés #}
        {% include 'partials/_documents_form.html.twig' with { form: form, relatedEntity: estimate } %}
        {# Documents liés #}

        <div class="flex justify-end items-center">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded btn-mobile">Enregistrer</button>
        </div>
    </fieldset>

    {{ form_end(form) }}

    {% if button_label is defined %}
        <div class="flex flex-col sm:flex-row gap-3 mt-4">
            <a href="{{ path('app_estimate_index') }}"
               class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-900 btn-mobile">← Retour à la liste</a>

            {{ include('estimate/_delete_form.html.twig') }}
        </div>
    {% else %}
        <a href="{{ path('app_estimate_index') }}"
           class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-900 mt-4 inline-block">← Retour à la liste</a>
    {% endif %}
</div>
