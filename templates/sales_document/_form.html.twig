{% import _self as f %}

{% macro field_errors(field) %}
    <div class="text-sm text-red-600 mt-1">
        {{ form_errors(field) }}
    </div>
{% endmacro %}

{% macro field_row(field, label, base_class, extra_attrs) %}
    {{ form_label(field, label, {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
    {% set attr = {'class': base_class ~ ' ' ~ (field.vars.errors|length ? 'border-red-500' : 'border-gray-300')} %}
    {% if extra_attrs is defined and extra_attrs %}
        {% set attr = attr|merge(extra_attrs) %}
    {% endif %}
    {{ form_widget(field, {'attr': attr}) }}
    {{ _self.field_errors(field) }}
{% endmacro %}

<div class="w-full mt-10 p-8 bg-white text-gray-900 rounded-xl shadow-xl">
        <h1 class="text-3xl font-bold mb-8 text-gray-900">
            {% if button_label is defined %}Modifier le document{% else %}Nouveau document{% endif %}
        </h1>

        {{ form_start(form, {
            'attr': {'class': 'space-y-8', 'enctype': 'multipart/form-data', 'novalidate': 'novalidate'}
        }) }}

        <!-- Informations générales -->
        <fieldset class="bg-gray-50 shadow rounded-lg p-8 space-y-6">
            <legend class="text-xl font-semibold text-gray-900 mb-4">Informations générales</legend>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    {{ f.field_row(form.reference, 'Référence', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                </div>

                <div>
                    {{ f.field_row(form.status, 'Statut', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                </div

                ><div>
                    {{ f.field_row(form.invoiceDate, "Date d'emission", 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                </div>

                {% if salesDocument.isInvoice() and form.externalInvoice is defined %}
                    <div class="md:col-span-2">
                        {{ f.field_row(form.externalInvoice, 'Facture externe (pour un ami)', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                    </div>
                {% endif %}

                <div class="md:col-span-2">
                    {{ form_label(form.notes, 'Notes', {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
                    {# {{ form_widget(form.notes, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900 px-3 py-2'}}) }}  #}
                    <div
                        data-controller="ckeditor"
                        data-ckeditor-toolbar-value='["bold","italic","bulletedList","numberedList","undo","redo"]'
                        data-ckeditor-license-key-value="GPL"
                    >
                        {{ form_widget(form.notes, {
                            attr: { 'data-ckeditor-target':'textarea', rows:5, class:'mt-1 w-full rounded-md bg-white ' ~ (form.notes.vars.errors|length ? 'border-red-500' : 'border-gray-300') }
                        }) }}
                    </div>
                    {{ f.field_errors(form.notes) }}
                </div>

                <!-- Client -->
                <div class="md:col-span-2" data-controller="sales-document"
                     data-action="change->sales-document#toggleClient"
                     data-has-project-select="false"
                     data-has-estimate-select="false">
                    <div data-sales-document-target="clientField">
                        {{ f.field_row(form.client, 'Client', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                    </div>
                </div>

                <!-- TVA fields -->
                <div>
                    {% if salesDocument.isInvoice() %}
                        {{ f.field_row(form.taxApplied, 'TVA appliquée', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                    {% else %}
                        {{ f.field_row(form.taxApplied, 'TVA appliquée', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2', {'disabled': false }) }}
                    {% endif %}
                </div>

                <div>
                    {% if salesDocument.isInvoice() %}
                        {{ f.field_row(form.vatRate, 'Taux TVA (%)', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                    {% else %}
                        {{ f.field_row(form.vatRate, 'Taux TVA (%)', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2', {'readonly': 'readonly'}) }}
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <!-- Lignes d'articles -->
        {% include 'sales_document/_items_section.html.twig' with { form: form } %}

        <!-- Bouton Enregistrer -->
        <div class="flex justify-end mt-8">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">
                Enregistrer
            </button>
        </div>

        {{ form_end(form) }}

        <!-- Retour / suppression -->
        {% if button_label is defined %}
            <div class="flex space-x-4 mt-4">
                <a href="{{ path('app_sales_document_index') }}"
                   class="px-4 py-2 bg-gray-300 hover:bg-gray-200 rounded text-gray-900">← Retour à la liste</a>

                {{ include('sales_document/_delete_form.html.twig') }}
            </div>
        {% else %}
            <a href="{{ path('app_sales_document_index') }}"
               class="px-4 py-2 bg-gray-300 hover:bg-gray-200 rounded text-gray-900 mt-4 inline-block">← Retour à la liste</a>
        {% endif %}
</div>
