{% import _self as f %}

{% macro field_errors(field) %}
    <div class="text-sm text-red-600 mt-1">
        {{ form_errors(field) }}
    </div>
{% endmacro %}

{% macro field_row(field, label, base_class, extra_attrs) %}
    {{ form_label(field, label, {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
    {% set attr = {'class': base_class ~ ' ' ~ (field.vars.errors|length ? 'border-red-500' : 'border-gray-300')} %}
    {% if extra_attrs is defined and extra_attrs %}
        {% set attr = attr|merge(extra_attrs) %}
    {% endif %}
    {{ form_widget(field, {'attr': attr}) }}
    {{ _self.field_errors(field) }}
{% endmacro %}

<div class="w-full mt-10 p-8 bg-white text-gray-900 rounded-xl shadow-xl">
        <h1 class="text-3xl font-bold mb-8 text-gray-900">
            {% if button_label is defined %}Modifier le document{% else %}Nouveau document{% endif %}
        </h1>

        {{ form_start(form, {
            'attr': {'class': 'space-y-8', 'enctype': 'multipart/form-data', 'novalidate': 'novalidate'}
        }) }}

        <!-- Informations générales -->
        <fieldset class="bg-gray-50 shadow rounded-lg p-8 space-y-6">
            <legend class="text-xl font-semibold text-gray-900 mb-4">Informations générales</legend>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    {{ f.field_row(form.reference, 'Référence', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                </div>

                <div>
                    {{ f.field_row(form.status, 'Statut', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                </div

                ><div>
                    {{ f.field_row(form.invoiceDate, "Date d'emission", 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                </div>

                {% if salesDocument.isInvoice() and form.externalInvoice is defined %}
                    <div class="md:col-span-2">
                        {{ f.field_row(form.externalInvoice, 'Facture externe (pour un ami)', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                    </div>
                {% endif %}

                <div class="md:col-span-2">
                    {{ form_label(form.notes, 'Notes', {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
                    {# {{ form_widget(form.notes, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900 px-3 py-2'}}) }}  #}
                    <div
                        data-controller="ckeditor"
                        data-ckeditor-toolbar-value='["bold","italic","bulletedList","numberedList","undo","redo"]'
                        data-ckeditor-license-key-value="GPL"
                    >
                        {{ form_widget(form.notes, {
                            attr: { 'data-ckeditor-target':'textarea', rows:5, class:'mt-1 w-full rounded-md bg-white ' ~ (form.notes.vars.errors|length ? 'border-red-500' : 'border-gray-300') }
                        }) }}
                    </div>
                    {{ f.field_errors(form.notes) }}
                </div>

                <!-- Client -->
                <div class="md:col-span-2"
                     data-controller="sales-document client-modal"
                     data-client-modal-endpoint-value="{{ path('client_create_from_modal') }}"
                     data-action="change->sales-document#toggleClient"
                     data-has-project-select="false"
                     data-has-estimate-select="false">
                    <div data-sales-document-target="clientField">
                        {{ form_label(form.client, 'Client', {'label_attr': {'class': 'block text-sm font-medium text-gray-900'}}) }}
                        {{ form_widget(form.client, {
                            'attr': {
                                'class': 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2 ' ~ (form.client.vars.errors|length ? 'border-red-500' : 'border-gray-300'),
                                'data-client-modal-target': 'clientSelect'
                            }
                        }) }}
                        {{ f.field_errors(form.client) }}
                        <div class="flex flex-wrap gap-3 text-sm mt-2">
                            <button type="button" class="text-blue-600 hover:text-blue-700" data-action="client-modal#openModal">+ Ajouter un nouveau client</button>
                            <a href="{{ path('app_client_new') }}" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-700">Ouvrir dans un nouvel onglet</a>
                        </div>

                        <div data-client-modal-target="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
                            <div class="w-full max-w-md rounded-lg bg-white p-6 text-gray-900 shadow-xl">
                                <div class="flex items-center justify-between mb-4">
                                    <h2 class="text-lg font-semibold">Créer un client</h2>
                                    <button type="button" class="text-gray-500 hover:text-gray-700" data-action="client-modal#closeModal">X</button>
                                </div>
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <label class="block text-sm font-medium text-gray-700">Nom</label>
                                        <input type="text" class="w-full rounded-md border border-gray-300 px-3 py-2" data-client-modal-target="nameInput" data-action="keydown.enter->client-modal#createClient" />
                                    </div>
                                    <div class="space-y-1">
                                        <label class="block text-sm font-medium text-gray-700">Devise</label>
                                        <select class="w-full rounded-md border border-gray-300 px-3 py-2" data-client-modal-target="currencySelect">
                                            <option value="">Sélectionnez une devise</option>
                                            <option value="EUR">Euro (€)</option>
                                            <option value="MAD">Dirham marocain (MAD)</option>
                                            <option value="USD">Dollar américain ($)</option>
                                        </select>
                                    </div>
                                    <div data-client-modal-target="error" class="hidden text-sm text-red-700 bg-red-50 border border-red-200 rounded-md px-3 py-2"></div>
                                    <div class="flex justify-end gap-2">
                                        <button type="button" class="px-3 py-2 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-800" data-action="client-modal#closeModal">Annuler</button>
                                        <button type="button" class="px-3 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white" data-action="client-modal#createClient">Créer</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TVA fields -->
                <div>
                    {% if salesDocument.isInvoice() %}
                        {{ f.field_row(form.taxApplied, 'TVA appliquée', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                    {% else %}
                        {{ f.field_row(form.taxApplied, 'TVA appliquée', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2', {'disabled': false }) }}
                    {% endif %}
                </div>

                <div>
                    {% if salesDocument.isInvoice() %}
                        {{ f.field_row(form.vatRate, 'Taux TVA (%)', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2') }}
                    {% else %}
                        {{ f.field_row(form.vatRate, 'Taux TVA (%)', 'mt-1 w-full rounded-md bg-white text-gray-900 px-3 py-2', {'readonly': 'readonly'}) }}
                    {% endif %}
                </div>
            </div>
        </fieldset>

        <!-- Lignes d'articles -->
        {% include 'sales_document/_items_section.html.twig' with { form: form } %}

        <!-- Bouton Enregistrer -->
        <div class="flex justify-end mt-8">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded btn-mobile">
                Enregistrer
            </button>
        </div>

        {{ form_end(form) }}

        <!-- Retour / suppression -->
        {% if button_label is defined %}
            <div class="flex flex-col sm:flex-row gap-3 mt-4">
                <a href="{{ path('app_sales_document_index') }}"
                   class="px-4 py-2 bg-gray-300 hover:bg-gray-200 rounded text-gray-900 btn-mobile">← Retour à la liste</a>

                {{ include('sales_document/_delete_form.html.twig') }}
            </div>
        {% else %}
            <a href="{{ path('app_sales_document_index') }}"
               class="px-4 py-2 bg-gray-300 hover:bg-gray-200 rounded text-gray-900 mt-4 inline-block">← Retour à la liste</a>
        {% endif %}
</div>
