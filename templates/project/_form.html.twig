<div class="mt-12 p-8 bg-white text-gray-900 rounded-xl">

{% if button_label is defined %}
        <h1 class="text-4xl font-extrabold mb-8">Modifier le projet</h1>
    {% else %}
        <h1 class="text-4xl font-extrabold mb-8">Nouveau projet</h1>
    {% endif %}

    {{ form_start(form, {'attr': {'class': 'space-y-8'}}) }}

    <!-- Informations générales -->
    <fieldset class="bg-gray-50 p-6 rounded-lg space-y-6 border border-gray-200">
        <legend class="text-2xl font-semibold text-gray-700">Informations générales</legend>

        <div class="space-y-2">
            {{ form_label(form.name, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
            {{ form_widget(form.name, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
            {{ form_errors(form.name) }}
        </div>

        {% if form.projectNumber is defined %}
            <div class="space-y-2">
                {{ form_label(form.projectNumber, 'Référence', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                {{ form_widget(form.projectNumber, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
                {{ form_errors(form.projectNumber) }}
            </div>
        {% endif %}

        <div data-controller="client-modal" data-client-modal-endpoint-value="{{ path('client_create_from_modal') }}" class="space-y-2">
            {{ form_label(form.client, 'Client', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
            {{ form_widget(form.client, {
                'attr': {
                    'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900',
                    'data-client-modal-target': 'clientSelect'
                }
            }) }}
            <div class="flex flex-wrap gap-3 text-sm">
                <button type="button" class="text-blue-600 hover:text-blue-700" data-action="client-modal#openModal">+ Ajouter un nouveau client</button>
                <a href="{{ path('app_client_new') }}" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-700">Ouvrir dans un nouvel onglet</a>
            </div>

            <div data-client-modal-target="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4">
                <div class="w-full max-w-md rounded-lg bg-white p-6 text-gray-900 shadow-xl">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold">Créer un client</h2>
                        <button type="button" class="text-gray-500 hover:text-gray-700" data-action="client-modal#closeModal">X</button>
                    </div>
                    <div class="space-y-4">
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">Nom</label>
                            <input type="text" class="w-full rounded-md border border-gray-300 px-3 py-2" data-client-modal-target="nameInput" data-action="keydown.enter->client-modal#createClient" />
                        </div>
                        <div class="space-y-1">
                            <label class="block text-sm font-medium text-gray-700">Devise</label>
                            <select class="w-full rounded-md border border-gray-300 px-3 py-2" data-client-modal-target="currencySelect">
                                <option value="">Sélectionnez une devise</option>
                                <option value="EUR">Euro (€)</option>
                                <option value="MAD">Dirham marocain (MAD)</option>
                                <option value="USD">Dollar américain ($)</option>
                            </select>
                        </div>
                        <div data-client-modal-target="error" class="hidden text-sm text-red-700 bg-red-50 border border-red-200 rounded-md px-3 py-2"></div>
                        <div class="flex justify-end gap-2">
                            <button type="button" class="px-3 py-2 rounded-md bg-gray-100 hover:bg-gray-200 text-gray-800" data-action="client-modal#closeModal">Annuler</button>
                            <button type="button" class="px-3 py-2 rounded-md bg-blue-600 hover:bg-blue-700 text-white" data-action="client-modal#createClient">Créer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-2">
            {{ form_label(form.description, 'Description', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
            {# {{ form_widget(form.description, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}, 'type': 'textarea'}) }}  #}
            <div
                data-controller="ckeditor"
                data-ckeditor-toolbar-value='["bold","italic","bulletedList","numberedList","undo","redo"]'
                data-ckeditor-license-key-value="GPL"
            >
                {{ form_widget(form.description, {
                    attr: { 'data-ckeditor-target':'textarea', rows:10, class:'mt-1 w-full rounded-md border-gray-300 bg-white', 'required': false }
                }) }}
            </div>
            {{ form_errors(form.description) }}
        </div>

        <div class="grid grid-cols-2 gap-4" data-controller="project-type" data-project-type-other-value-value="other">
            <div>
                {{ form_label(form.status, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                {{ form_widget(form.status, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
                {{ form_errors(form.status) }}
            </div>
            <div>
                {{ form_label(form.type, null, {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                {{ form_widget(form.type, {
                    'attr': {
                        'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900',
                        'data-project-type-target': 'typeSelect',
                        'data-action': 'change->project-type#toggle'
                    }
                }) }}
                {{ form_errors(form.type) }}
            </div>
            <div class="col-span-2 hidden" data-project-type-target="details">
                {{ form_label(form.typeDescription, 'Précisez le type *', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                {{ form_widget(form.typeDescription, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
                {{ form_errors(form.typeDescription) }}
                <p class="text-xs text-gray-500 mt-1">Obligatoire si le type est “Autre”.</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                {{ form_label(form.startDate, 'Date début', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                {{ form_widget(form.startDate, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
                {{ form_errors(form.startDate) }}
            </div>
            <div>
                {{ form_label(form.endDate, 'Date fin', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                {{ form_widget(form.endDate, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
                {% if form.endDate.vars.errors|length > 0 %}
                    <div class="mt-2 text-sm font-semibold text-red-700 bg-red-50 border border-red-200 rounded-md px-3 py-2">
                        <div class="flex items-start gap-2">
                            <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-red-100 text-red-700 text-xs font-bold">!</span>
                            <div>
                                <div class="uppercase tracking-wide text-[11px] text-red-700">Erreur</div>
                                {{ form_errors(form.endDate) }}
                            </div>
                        </div>
                    </div>
                {% else %}
                    {{ form_errors(form.endDate) }}
                {% endif %}
                <p class="text-xs text-gray-500 mt-1">La date de fin doit être postérieure ou égale à la date de début.</p>
            </div>
        </div>
    </fieldset>

    <!-- TVA -->
    <fieldset class="bg-gray-50 p-6 rounded-lg space-y-4 border border-gray-200" data-controller="toggle-vat">
        <legend class="text-2xl font-semibold text-gray-700">TVA</legend>

        <div>
            {{ form_label(form.amount, 'Montant HT', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
            {{ form_widget(form.amount, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
            {{ form_errors(form.amount) }}
        </div>

        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
            {{ form_widget(form.noVat, {
                'attr': {
                    'data-toggle-vat-target': 'checkbox',
                    'data-action': 'toggle-vat#toggle'
                }
            }) }}
            {{ form_label(form.noVat, 'Pas de TVA', {'label_attr': {'class': 'text-sm text-gray-700'}}) }}
        </div>

        <div data-toggle-vat-target="vat" class="mt-2">
            {{ form_label(form.vatRate, 'TVA (%)', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
            {{ form_widget(form.vatRate, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900', 'step': '0.01'}}) }}
            {{ form_errors(form.vatRate) }}
        </div>
    </fieldset>

    <!-- Récurrence -->
    <fieldset class="bg-gray-50 p-6 rounded-lg space-y-4 border border-gray-200" data-controller="toggle-visibility">
        <legend class="text-2xl font-semibold text-gray-700">Récurrence</legend>

        <div class="flex flex-col sm:flex-row sm:items-center gap-3">
            {{ form_widget(form.isRecurring, {
                'attr': {
                    'data-toggle-visibility-target': 'checkbox',
                    'data-action': 'toggle-visibility#toggle'
                }
            }) }}
            {{ form_label(form.isRecurring, 'Projet récurrent', {'label_attr': {'class': 'text-sm text-gray-700'}}) }}
        </div>

        <div data-toggle-visibility-target="toggleField" class="space-y-4 hidden mt-2">
            <div>
                {{ form_label(form.recurringAmount, 'Montant récurrent', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                {{ form_widget(form.recurringAmount, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
                {{ form_errors(form.recurringAmount) }}
            </div>

            <div>
                {{ form_label(form.recurringPeriod, 'Périodicité', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                {{ form_widget(form.recurringPeriod, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
                {{ form_errors(form.recurringPeriod) }}
            </div>
        </div>
    </fieldset>

    <!-- Documents -->
    <fieldset class="bg-gray-50 p-6 rounded-lg space-y-4 border border-gray-200">
        <legend class="text-2xl font-semibold text-gray-700">Documents</legend>
        {% include 'partials/_documents_form.html.twig' with { form: form, relatedEntity: project } %}
    </fieldset>

    {% if form.salesDocuments is defined %}
        <!-- Factures liées -->
        <fieldset class="bg-gray-50 p-6 rounded-lg space-y-4 border border-gray-200">
            <legend class="text-2xl font-semibold text-gray-700">Factures liées</legend>
            <div class="space-y-2">
                {{ form_label(form.salesDocuments, 'Sélectionner des factures', {'label_attr': {'class': 'block text-sm font-medium text-gray-700'}}) }}
                {{ form_widget(form.salesDocuments, {'attr': {'class': 'mt-1 w-full rounded-md border-gray-300 bg-white text-gray-900'}}) }}
                {{ form_errors(form.salesDocuments) }}
            </div>
            {% if project.salesDocuments|length > 0 %}
                <div class="pt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Factures déjà liées</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-700">
                            <thead class="bg-gray-100 text-xs uppercase">
                            <tr>
                                <th class="px-4 py-2 border-b">Réf.</th>
                                <th class="px-4 py-2 border-b">Type</th>
                                <th class="px-4 py-2 border-b">Date</th>
                                <th class="px-4 py-2 border-b">Actions</th>
                            </tr>
                            </thead>
                            <tbody class="divide-y">
                            {% for doc in project.salesDocuments %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2">{{ doc.reference }}</td>
                                    <td class="px-4 py-2">{{ doc.type }}</td>
                                    <td class="px-4 py-2">{{ doc.createdAt ? doc.createdAt|date('d/m/Y') : '—' }}</td>
                                    <td class="px-4 py-2">
                                        <a href="{{ path('app_sales_document_show', { id: doc.id }) }}"
                                           class="text-blue-600 hover:text-blue-500 btn-mobile">Voir</a>
                                        <a href="{{ path('app_sales_document_edit', { id: doc.id }) }}"
                                           class="text-yellow-600 hover:text-yellow-500 btn-mobile">Modifier</a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% endif %}
        </fieldset>
    {% endif %}

    <!-- Bouton -->
    <div class="flex justify-end mt-6">
        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors btn-mobile">Enregistrer</button>
    </div>

    {{ form_end(form) }}

    {% if button_label is defined %}
        <div class="flex flex-col sm:flex-row gap-3 mt-4">
            <a href="{{ path('app_project_index') }}"
               class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-900 btn-mobile">← Retour à la liste</a>

            {{ include('project/_delete_form.html.twig') }}
        </div>
    {% else %}
        <a href="{{ path('app_project_index') }}"
           class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded text-gray-900 mt-4 inline-block">← Retour à la liste</a>
    {% endif %}
</div>
